---
- hosts: localhost
  connection: local
  gather_facts: yes
  vars:
    login: &login
      server_url: "{{ server_url}}"
      username: "{{ username }}"
      password: "{{ password }}"
      validate_certs: "{{ validate_certs }}"
  tasks:
  - name: "Show repositories"
    redhat.satellite.resource_info:
      <<: *login
      resource: "repositories"
    register: result

  - name: "Check if result is successful"
    assert:
      that:
        - result.resources[0].last_sync.result == "success"
      fail_msg: "The last sync result is not successful."

  - name: Show current time in seconds
    debug:
      msg: "{{ ansible_date_time.epoch | int }}"

  - name: Show variable time in seconds
    debug:
      var: "{{ result.resources[0].last_sync.ended_at| split | first | to_datetime('%Y-%m-%d') }}"

  - name: "Check if ended is less than 7 days"
    assert:
      that:
        - (ansible_date_time.epoch | int) - (result.resources[0].last_sync.ended_at| split | first | to_datetime('%Y-%m-%d')).seconds < 604800
      fail_msg: "The last sync ended more than 7 days ago."